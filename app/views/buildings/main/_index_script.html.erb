<script type="text/javascript">
(function() {
  'use strict';
  
  // Use a namespace to avoid conflicts
  if (!window.BuildingsGrid) {
    window.BuildingsGrid = {};
  }
  
  let initializationPending = false;

  const initializeBuildingsGrid = () => {
    const gridElement = document.querySelector('#grid');
    if (!gridElement) {
      // Clean up if grid element doesn't exist
      if (window.buildingsGrid) {
        window.buildingsGrid.destroy();
        window.buildingsGrid = null;
      }
      initializationPending = false;
      return;
    }

    // Prevent double initialization - if already initializing or already initialized for this element, skip
    if (initializationPending) {
      return;
    }

    // Check if grid is already initialized for this element
    if (window.buildingsGrid) {
      try {
        const existingGui = window.buildingsGrid.getGui();
        if (existingGui && gridElement.contains(existingGui)) {
          // Grid already initialized for this element
          return;
        }
      } catch (e) {
        // Grid might be in invalid state, continue with reinitialization
      }
    }

    initializationPending = true;

    // Destroy existing grid if it exists (for Turbo navigation)
    if (window.buildingsGrid) {
      try {
        window.buildingsGrid.destroy();
      } catch (e) {
        // Grid might already be destroyed
        console.debug('Buildings grid destroy error (ignored):', e);
      }
      window.buildingsGrid = null;
    }

    // Clear the grid element completely before reinitializing
    gridElement.innerHTML = '';

    // Only initialize advancedSearch if jQuery and the plugin are available
    if (typeof window.jQuery !== 'undefined' && window.jQuery.fn.advancedSearch) {
      const $form = window.jQuery('#new_s');
      // Destroy existing advancedSearch instance if it exists
      if ($form.data('search')) {
        $form.data('search', null);
      }
      $form.advancedSearch({
        url: '/buildings/advanced_search_filters.json',
        fields: <%== @search.f.to_json -%>,
        filters: <%== @search.s.to_json -%>
      });
    }

    if (typeof agGrid !== 'undefined') {
      const gridOptions = {
        components: {
          nameCellRenderer: NameCellRenderer, htmlCellRenderer: HTMLCellRenderer
        },
        columnDefs: <%== BuildingGridTranslator.new(@search).column_def.to_json -%>,
        defaultColDef: { width: 100, resizable: true },
        rowSelection: 'single',
        rowModelType: 'infinite',
        datasource: GridDataSource,
        // Ensure resize handles work after Turbo navigation
        onFirstDataRendered: () => {
          // Grid is ready - resize handles should now be functional
          if (window.buildingsGrid && window.buildingsGrid.api) {
            // Trigger a refresh to ensure resize handles are active
            window.buildingsGrid.api.refreshHeader();
          }
          initializationPending = false;
        }
      };
      
      window.buildingsGrid = new agGrid.Grid(gridElement, gridOptions);
      // Reset flag after a short delay in case onFirstDataRendered doesn't fire immediately
      setTimeout(() => {
        initializationPending = false;
      }, 1000);
    } else {
      initializationPending = false;
    }
  };

  // Remove old listeners if they exist
  if (window.BuildingsGrid.initialized) {
    document.removeEventListener('DOMContentLoaded', window.BuildingsGrid.initializeHandler);
    document.removeEventListener('turbo:load', window.BuildingsGrid.initializeHandler);
    document.removeEventListener('turbo:before-cache', window.BuildingsGrid.cleanupHandler);
  }

  // Store handlers for cleanup
  window.BuildingsGrid.initializeHandler = initializeBuildingsGrid;
  window.BuildingsGrid.cleanupHandler = () => {
    if (window.buildingsGrid) {
      window.buildingsGrid.destroy();
      window.buildingsGrid = null;
    }
    initializationPending = false;
  };

  // Use a single initialization function that prevents double calls
  // Turbo fires turbo:load on both initial page load and navigation
  // We also listen to DOMContentLoaded as a fallback for initial page load
  // The initializationPending flag prevents double initialization
  const safeInitialize = () => {
    if (!initializationPending) {
      window.BuildingsGrid.initializeHandler();
    }
  };

  document.addEventListener('turbo:load', safeInitialize);
  // Fallback for initial page load if Turbo hasn't initialized yet
  // Only add DOMContentLoaded listener if DOM is still loading
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', safeInitialize);
  }
  document.addEventListener('turbo:before-cache', window.BuildingsGrid.cleanupHandler);

  window.BuildingsGrid.initialized = true;
})();
</script>
