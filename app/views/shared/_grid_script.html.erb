<script type="text/javascript">
const initializeGrid = () => {
  const gridElement = document.querySelector('#grid');
  if (!gridElement) return;

  // Destroy existing grid if it exists (for Turbo navigation)
  if (window.currentGrid) {
    window.currentGrid.destroy();
    window.currentGrid = null;
  }

  $('#new_s').advancedSearch({
    url: '<%= File.join(url_for().sub(/\/unhoused|\/unreviewed|\/unmatched/, ""), "advanced_search_filters.json") -%>',
    fields: <%== @search.f.to_json.html_safe -%>,
    filters: <%== @search.s.to_json.html_safe -%>
  });

  window.currentGrid = new agGrid.Grid(gridElement, {
    components: {
      actionCellRenderer: ActionCellRenderer,
      censusLinkCellRenderer: CensusLinkCellRenderer,
      nameCellRenderer: NameCellRenderer,
      htmlCellRenderer: HTMLCellRenderer
    },
    columnDefs: <%== @translator.column_def.to_json -%>,
    defaultColDef: { width: 100 },
    rowSelection: 'single',
    rowModelType: 'infinite',
    datasource: GridDataSource
  });
};

// Handle both initial page load and Turbo navigation
document.addEventListener('DOMContentLoaded', initializeGrid);
document.addEventListener('turbo:load', initializeGrid);

// Cleanup before Turbo caches the page
document.addEventListener('turbo:before-cache', () => {
  if (window.currentGrid) {
    window.currentGrid.destroy();
    window.currentGrid = null;
  }
});
</script>
